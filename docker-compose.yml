version: '3.8'

services:
  neon-arcade-multiplayer:
    build:
      context: .
      dockerfile: Dockerfile
    container_name: neon-arcade-multiplayer
    ports:
      # Frontend ports for 3 players
      - "5173:5173"    # Player 1 frontend
      - "5174:5174"    # Player 2 frontend
      - "5175:5175"    # Player 3 frontend
      # GraphQL services
      - "9002:9002"    # Player 1 GraphQL
      - "9003:9003"    # Player 2 GraphQL
      - "9004:9004"    # Player 3 GraphQL
      # Shared services
      - "8080:8080"    # Shared faucet
      # Validators
      - "13001:13001"  # Player 1 validator
      - "13002:13002"  # Player 2 validator
      - "13003:13003"  # Player 3 validator
    volumes:
      # Mount source code for development
      - ./src:/build/src
      - ./contracts:/build/contracts
      - ./public:/build/public
      - ./index.html:/build/index.html
      - ./vite.config.ts:/build/vite.config.ts
      - ./package.json:/build/package.json
      - ./tsconfig.json:/build/tsconfig.json
      - ./tsconfig.node.json:/build/tsconfig.node.json
      # Multi-player orchestration script
      - ./run-multiplayer.bash:/build/run-multiplayer.bash
      # Preserve node_modules and build artifacts in container
      - node_modules:/build/node_modules
      - contracts_target:/build/contracts/target
      # Persist Linera network state between restarts
      - linera_data:/root/.cache/linera
    environment:
      - NODE_ENV=development
      # Multi-player configuration
      - NEON_ARCADE_PLAYERS=3
      - BASE_GRAPHQL_PORT=9002
      - BASE_FRONTEND_PORT=5173
      - FAUCET_PORT=8080
      # These will be generated by run-multiplayer.bash for each player
      - VITE_LINERA_FAUCET_URL=http://localhost:8080
    stdin_open: true
    tty: true
    healthcheck:
      test: ["CMD", "bash", "-c", "curl -sf http://localhost:5173 && curl -sf http://localhost:5174 && curl -sf http://localhost:5175"]
      interval: 30s
      timeout: 10s
      retries: 10
      start_period: 10m  # Longer for multi-instance setup
    networks:
      - linera-net

volumes:
  node_modules:
  contracts_target:
  linera_data:  # Persist Linera network state

networks:
  linera-net:
    driver: bridge
